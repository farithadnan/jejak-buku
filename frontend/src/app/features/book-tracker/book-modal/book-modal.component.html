<div class="modal-backdrop fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm p-2 sm:p-4"
     (touchmove)="preventBackgroundScroll($event)"
     (wheel)="preventBackgroundScroll($event)"
     (scroll)="preventBackgroundScroll($event)">
  <div class="modal-container bg-white rounded-lg shadow-lg w-full max-w-full sm:max-w-3xl relative overflow-hidden mx-2 flex flex-col"
       [style.max-height]="modalMaxHeight"
       (touchmove)="$event.stopPropagation()">
    <!-- Modal Header (fixed at top) -->
    <div class="flex items-center justify-between px-4 py-3 border-b border-gray-200 flex-shrink-0">
      <h2 class="text-base font-semibold m-0">
        {{ mode === 'edit' ? 'Edit Book' : 'Add Book' }}
      </h2>
      <button
        class="text-gray-400 hover:text-red-500 text-3xl p-2 rounded-full bg-white bg-opacity-80 cursor-pointer leading-none"
        (click)="onCancel()"
        aria-label="Close"
        style="z-index:10; line-height: 1;"
      >
        &times;
      </button>
    </div>

    <!-- Scrollable Form Content -->
    <div class="modal-content flex-1 overflow-y-auto p-4"
         (touchstart)="onContentTouchStart($event)"
         (touchmove)="onContentTouchMove($event)">
      <!-- Rest of your form content remains the same -->
      <form [formGroup]="form" (ngSubmit)="onSubmit()">
        <div class="flex flex-col md:flex-row gap-4">
          <!-- Left Column -->
          <div class="w-full md:w-1/2 flex flex-col gap-3">
            <!-- Book Cover Upload -->
            <div class="flex flex-col items-center">
              <label class="block text-sm font-semibold mb-1 w-full text-left">Book Cover</label>
              <ng-container *ngIf="imagePreview; else uploadArea">
                <div class="relative w-32 h-44 mb-2">
                  <img [src]="imagePreview" alt="Book cover preview" class="w-32 h-44 object-cover rounded border" />
                  <button
                    type="button"
                    class="absolute bottom-2 right-2 bg-white bg-opacity-80 rounded-full p-1 shadow hover:bg-blue-100 cursor-pointer"
                    (click)="fileInput.click()"
                    title="Change cover"
                    aria-label="Edit cover"
                    style="right: 8px; bottom: 8px;"
                  >
                    <!-- Pencil icon -->
                    <svg class="h-4 w-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15.232 5.232l3.536 3.536M9 13l6-6m2 2l-6 6M4 20h4l10-10a2.828 2.828 0 10-4-4L4 16v4z" />
                    </svg>
                  </button>
                  <button
                    type="button"
                    class="absolute top-2 left-2 bg-red-100 text-red-700 rounded-full p-1 shadow hover:bg-red-200 text-xs cursor-pointer"
                    (click)="removeImage(); markAsInteracted(); $event.stopPropagation()"
                    title="Remove cover"
                    aria-label="Remove cover"
                  >
                    <!-- Trash icon -->
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M6 7v12a2 2 0 002 2h8a2 2 0 002-2V7M4 7h16M10 11v6M14 11v6M9 7V4a1 1 0 011-1h4a1 1 0 011 1v3" />
                    </svg>
                  </button>
                  <input
                    #fileInput
                    type="file"
                    accept="image/*"
                    (change)="onImageChange($event); markAsInteracted()"
                    class="hidden"
                  />
                </div>
              </ng-container>
              <ng-template #uploadArea>
                <!-- Enhanced upload area -->
                <div
                  class="flex flex-col items-center justify-center border-2 border-dashed border-gray-300 rounded-lg bg-gray-50 p-4 cursor-pointer hover:border-blue-400 transition"
                  (click)="fileInput.click(); markAsInteracted()"
                  (drop)="onImageChange($event); markAsInteracted(); $event.preventDefault()"
                  (dragover)="$event.preventDefault()"
                  tabindex="0"
                  style="outline: none;"
                >
                  <input
                    #fileInput
                    type="file"
                    accept="image/png, image/jpeg, image/jpg, image/gif, image/webp"
                    (change)="onImageChange($event); markAsInteracted()"
                    class="hidden"
                  />
                  <svg class="h-8 w-8 text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                  </svg>
                  <div class="text-gray-500 text-sm mb-1">
                    <span class="font-medium text-blue-600">Upload a file</span>
                    <span class="mx-1">or</span>
                    drag and drop
                  </div>
                  <div class="text-xs text-gray-400 mb-2">PNG, JPG, GIF, WebP up to 10MB</div>
                  <div class="text-xs text-gray-400">Images will be automatically compressed</div>
                </div>
              </ng-template>
            </div>

            <!-- Rest of left column fields -->
            <div>
              <label class="block text-xs font-semibold mb-1">Title *</label>
              <input
                formControlName="title"
                placeholder="Enter book title"
                required
                class="border rounded p-2 w-full text-sm transition-colors duration-200"
                [class.border-red-500]="form.get('title')?.invalid && form.get('title')?.touched"
                [class.border-gray-300]="!(form.get('title')?.invalid && form.get('title')?.touched)"
                [class.bg-red-50]="form.get('title')?.invalid && form.get('title')?.touched"
                (input)="markAsInteracted()"
              />
              <div *ngIf="form.get('title')?.invalid && form.get('title')?.touched" class="text-xs text-red-500 mt-1 flex items-center">
                <svg class="h-3 w-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
                Title is required
              </div>
            </div>

            <div>
              <label class="block text-xs font-semibold mb-1">Author *</label>
              <input
                formControlName="author"
                placeholder="Enter author name"
                required
                class="border rounded p-2 w-full text-sm transition-colors duration-200"
                [class.border-red-500]="form.get('author')?.invalid && form.get('author')?.touched"
                [class.border-gray-300]="!(form.get('author')?.invalid && form.get('author')?.touched)"
                [class.bg-red-50]="form.get('author')?.invalid && form.get('author')?.touched"
                (input)="markAsInteracted()"
              />
              <div *ngIf="form.get('author')?.invalid && form.get('author')?.touched" class="text-xs text-red-500 mt-1 flex items-center">
                <svg class="h-3 w-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
                Author is required
              </div>
            </div>

            <div>
              <label class="block text-xs font-semibold mb-1">Status *</label>
              <select
                formControlName="status"
                required
                class="border rounded p-2 w-full text-sm transition-colors duration-200"
                [class.border-red-500]="form.get('status')?.invalid && form.get('status')?.touched"
                [class.border-gray-300]="!(form.get('status')?.invalid && form.get('status')?.touched)"
                [class.bg-red-50]="form.get('status')?.invalid && form.get('status')?.touched"
                (change)="markAsInteracted()"
              >
                <option value="planned">Planned</option>
                <option value="reading">Reading</option>
                <option value="completed">Completed</option>
              </select>
              <div *ngIf="form.get('status')?.invalid && form.get('status')?.touched" class="text-xs text-red-500 mt-1 flex items-center">
                <svg class="h-3 w-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
                Status is required
              </div>
            </div>

            <div>
              <label class="block text-xs font-semibold mb-1">Genres</label>
              <div class="border rounded p-2 flex flex-wrap gap-1 max-h-24 overflow-y-auto bg-gray-50">
                <span *ngFor="let genre of form.value.genres; let gi = index" class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs flex items-center">
                  {{ genre }}
                  <button type="button" (click)="removeGenre(gi); markAsInteracted()" class="ml-2 text-blue-700 hover:text-red-500 focus:outline-none text-lg cursor-pointer" aria-label="Remove genre">&times;</button>
                </span>
                <div class="flex items-center gap-1 min-w-0 flex-1">
                  <input
                    type="text"
                    [(ngModel)]="newGenre"
                    [ngModelOptions]="{standalone: true}"
                    (keydown)="onGenreKeydown($event)"
                    (input)="markAsInteracted()"
                    (blur)="addGenreOnBlur()"
                    [placeholder]="form.value.genres.length === 0 ? 'Enter genre' : ''"
                    class="border-none bg-transparent text-sm focus:outline-none flex-1 min-w-0"
                    name="newGenre"
                    autocomplete="off"
                    inputmode="text"
                  />
                  <button
                    type="button"
                    (click)="addGenre(); markAsInteracted()"
                    class="text-blue-600 hover:text-blue-800 text-sm font-medium px-1"
                    [disabled]="!newGenre.trim()"
                    title="Add genre"
                  >
                    +
                  </button>
                </div>
              </div>
              <div class="mt-1 flex flex-wrap gap-1">
                <button
                  *ngFor="let genre of allGenres"
                  type="button"
                  class="bg-gray-200 text-gray-700 px-2 py-0.5 rounded text-xs hover:bg-blue-100 hover:text-blue-700 cursor-pointer"
                  (click)="selectGenre(genre)"
                  [disabled]="form.value.genres?.includes(genre)"
                >
                  {{ genre }}
                </button>
              </div>
            </div>

            <!-- Rest of your form fields... -->
            <div class="flex gap-2">
              <div class="flex-1">
                <label class="block text-xs font-semibold mb-1">Current Page</label>
                <input
                  type="number"
                  min="0"
                  formControlName="currentPage"
                  placeholder="Enter current page"
                  class="border rounded p-2 w-full text-sm"
                  (input)="markAsInteracted()"
                />
              </div>
              <div class="flex-1">
                <label class="block text-xs font-semibold mb-1">Total Pages</label>
                <input
                  type="number"
                  min="1"
                  formControlName="pages"
                  placeholder="Enter total pages"
                  class="border rounded p-2 w-full text-sm"
                  (input)="markAsInteracted()"
                />
              </div>
            </div>

            <!-- Rating, ISBN, Published Date -->
            <div>
              <label class="block text-xs font-semibold mb-1">Rating</label>
              <select
                formControlName="rating"
                class="border rounded p-2 w-full text-sm"
                (change)="markAsInteracted()"
              >
                <option [ngValue]="undefined">No rating</option>
                <option *ngFor="let r of [1,2,3,4,5]" [ngValue]="r">{{ r }}</option>
              </select>
            </div>

            <div>
              <label class="block text-xs font-semibold mb-1">ISBN</label>
              <input
                formControlName="isbn"
                placeholder="Enter ISBN"
                class="border rounded p-2 w-full text-sm"
                (input)="markAsInteracted()"
              />
            </div>

            <div>
              <label class="block text-xs font-semibold mb-1">Published Date</label>
              <input
                type="date"
                formControlName="publishedDate"
                class="border rounded p-2 w-full text-sm"
                (change)="markAsInteracted()"
              />
            </div>
          </div>

          <!-- Divider for desktop -->
          <div class="hidden md:block w-px bg-gray-200 mx-2"></div>

          <!-- Right Column -->
          <div class="w-full md:w-1/2 flex flex-col gap-3">
            <div>
              <label class="block text-xs font-semibold mb-1">Description</label>
              <textarea
                formControlName="description"
                placeholder="Enter short description"
                rows="2"
                class="border rounded p-2 w-full text-sm"
                (input)="markAsInteracted()"
              ></textarea>
            </div>

            <div>
              <label class="block text-xs font-semibold mb-1">Notes</label>
              <textarea
                formControlName="notes"
                placeholder="Enter personal notes"
                rows="2"
                class="border rounded p-2 w-full text-sm"
                (input)="markAsInteracted()"
              ></textarea>
            </div>

            <div class="flex items-center gap-2">
              <div class="flex-1">
                <label class="block text-xs font-semibold mb-1">Start Date</label>
                <input
                  type="date"
                  formControlName="startedDate"
                  class="border rounded p-2 w-full text-sm"
                  (change)="markAsInteracted()"
                />
              </div>
              <label class="flex items-center text-xs gap-1 mt-5">
                <input
                  #startDateCheckbox
                  type="checkbox"
                  [checked]="unknownStartDate"
                  (change)="setUnknownDate('startedDate', startDateCheckbox.checked); markAsInteracted()"
                />
                Unknown
              </label>
            </div>

            <div class="flex items-center gap-2">
              <div class="flex-1">
                <label class="block text-xs font-semibold mb-1">Finished Date</label>
                <input
                  type="date"
                  formControlName="completedDate"
                  class="border rounded p-2 w-full text-sm"
                  (change)="markAsInteracted()"
                />
              </div>
              <label class="flex items-center text-xs gap-1 mt-5">
                <input
                  #completedDateCheckbox
                  type="checkbox"
                  [checked]="unknownCompletedDate"
                  (change)="setUnknownDate('completedDate', completedDateCheckbox.checked); markAsInteracted()"
                />
                Unknown
              </label>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- Fixed Footer with Buttons -->
    <div class="flex-shrink-0 border-t border-gray-200 p-4 bg-gray-50">
      <div class="flex justify-between gap-2">
        <!-- Delete button for edit mode only -->
        <button
          *ngIf="mode === 'edit'"
          type="button"
          (click)="onDelete()"
          class="px-4 py-2 rounded bg-red-100 text-red-700 hover:bg-red-200 flex items-center gap-1 cursor-pointer"
        >
          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M6 7v12a2 2 0 002 2h8a2 2 0 002-2V7M4 7h16M10 11v6M14 11v6M9 7V4a1 1 0 011-1h4a1 1 0 011 1v3" />
          </svg>
          Delete
        </button>

        <!-- Cancel/Save buttons container -->
        <div class="flex gap-2" [ngClass]="{ 'ml-auto': mode === 'edit', 'w-full justify-end': mode === 'create' }">
          <button
            type="button"
            (click)="onCancel()"
            class="px-4 py-2 rounded bg-gray-200 text-gray-700 hover:bg-gray-300 cursor-pointer"
          >
            Cancel
          </button>

          <button
            type="button"
            (click)="onSubmit()"
            class="px-4 py-2 rounded text-white cursor-pointer transition-colors duration-200 min-w-[80px] font-medium"
            [disabled]="isFormInvalid()"
            [ngClass]="{
              'bg-green-600 hover:bg-green-700': mode === 'create' && !isFormInvalid(),
              'bg-green-400 cursor-not-allowed': mode === 'create' && isFormInvalid(),
              'bg-blue-600 hover:bg-blue-700': mode === 'edit' && !isFormInvalid(),
              'bg-red-500 hover:bg-red-600': mode === 'edit' && isFormInvalid() && hasRequiredFieldsTouched(),
              'bg-blue-400 cursor-not-allowed': mode === 'edit' && isFormInvalid() && !hasRequiredFieldsTouched()
            }"
          >
            {{ getSaveButtonText() }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Confirmation Dialog -->
<div *ngIf="showConfirmDialog" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm"
     (touchmove)="preventBackgroundScroll($event)">
  <div class="bg-white rounded-lg shadow-lg p-6 mx-4 max-w-sm w-full">
    <div class="flex items-center mb-4">
      <svg class="h-6 w-6 text-yellow-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
      </svg>
      <h3 class="text-lg font-semibold text-gray-900">{{ confirmAction.title }}</h3>
    </div>
    <p class="text-gray-600 mb-6">{{ confirmAction.message }}</p>
    <div class="flex gap-3 justify-end">
      <button
        (click)="cancelConfirmation()"
        class="px-4 py-2 rounded bg-gray-200 text-gray-700 hover:bg-gray-300 cursor-pointer"
      >
        Cancel
      </button>
      <button
        (click)="confirmAction.callback()"
        class="px-4 py-2 rounded cursor-pointer"
        [ngClass]="{
          'bg-red-600 text-white hover:bg-red-700': confirmAction.type === 'delete',
          'bg-blue-600 text-white hover:bg-blue-700': confirmAction.type !== 'delete'
        }"
      >
        {{ confirmAction.confirmText }}
      </button>
    </div>
  </div>
</div>

<!-- Add this to the component where image is being processed -->

<div *ngIf="processingImage" class="flex flex-col items-center p-4">
  <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-2"></div>
  <div class="text-xs text-gray-500">Compressing image...</div>
</div>
